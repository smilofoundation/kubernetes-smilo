<%
def set_node_template_vars(values)
    @Node_UserIdent        = values["Node_UserIdent"]
    return
end
-%>
---

<%- @nodes.each do |node| -%>
<%= set_node_template_vars(node.values.first) -%>

<%
@Service_Prefix = (@Node_UserIdent.upcase).gsub("-", "_")
@Geth_Verbosity        = @config["geth"]["verbosity"]
@Geth_Network_Id       = @config["geth"]["network"]["id"]
@Node_WSPort           = @config["geth"]["Node_WSPort"]
@NodeP2P_ListenAddr    = @config["geth"]["NodeP2P_ListenAddr"]

if @config["geth"]["Geth_Startup_Params"]
  @Geth_Startup_Params   = @config["geth"]["Geth_Startup_Params"]
else
  @Geth_Startup_Params   = ""
end

@Node_DataDir          = @config["quorum"]["Node_DataDir"]
@Quorum_Version        = @config["quorum"]["quorum"]["Quorum_Version"]
@Tm_Version            = @config["quorum"]["tm"]["Tm_Version"]
@Tm_Port               = @config["quorum"]["tm"]["Port"]
@Tm_Name               = @config["quorum"]["tm"]["Name"]

# Storage for data directories, default host with default DataDir (hostPath).
@Storage_Type          = "Host"
@DataDir               = "/var/lib/docker/geth-storage"
if @config["quorum"]["Data_Dir"]
    @DataDir = @config["quorum"]["Data_Dir"]
end
# if storage is set set up the appropriate storage variable (host or PVC)
if @config["quorum"]["storage"]
  if @config["quorum"]["storage"]["Type"] == "Host"
    @Storage_Type = "Host"
    if @config["quorum"]["storage"]["Data_Dir"]
      @DataDir = @config["quorum"]["storage"]["Data_Dir"]
    end
  # Persistent_Volume_Claim
  elsif @config["quorum"]["storage"]["Type"] == "PVC"
    @Storage_Type = "PVC"
  end
end
%>

# The quorum deployment consists of
# 1. the transaction manager / private tx container (constellation or tessera)
# 2. the quorum node container

---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: <%= @Node_UserIdent %>-deployment
  <%= @Namespace %>
spec:
  strategy:
    type: RollingUpdate
  replicas: 1
  template:
    metadata:
      name:  <%= @Node_UserIdent %>-deployment
      labels:
        app: qubernetes
        tier: backend
        name: <%= @Node_UserIdent %>-deployment
    spec:
      initContainers:
      - name: quorum-genesis-init-container
        image: quay.io/smilo/go-smilo:<%= @Quorum_Version %>
        command: [ "sh" ]
        args:
        - "-cx"
        - "if [ ! -f $QUORUM_DATA_DIR/genesis_created ]; then
              /usr/local/bin/geth --datadir $QUORUM_DATA_DIR init /etc/quorum/genesis/genesis-geth.json;
              touch $QUORUM_DATA_DIR/genesis_created;
           fi;
           cp -r <%= @Node_DataDir %>/contracts-tmp <%= @Node_DataDir %>/contracts;
           chmod 755  <%= @Node_DataDir %>/contracts/runscript.sh;
          "
        env:
          - name: QUORUM_DATA_DIR
            value: <%= @Node_DataDir %>/dd
        volumeMounts:
        - name: quorum-persistent-storage
          mountPath:  <%= @Node_DataDir %>
        - name: genesis-config-persistent-storage
          mountPath: /etc/quorum/genesis/genesis-geth.json
          subPath: genesis-geth.json
        - name: contracts-config
          mountPath: <%= @Node_DataDir%>/contracts-tmp
          readOnly: false
      containers:
      - name: tessera
        image: quay.io/smilo/smilo-blackbox:<%= @Tm_Version %>
        command: ["sh"]
        args:
        - "-cx"
        - "chmod 600 $QUORUM_HOME/tm/tm.key;
           echo DDIR is $DDIR;
           printenv;

           TESSERA_VERSION=<%= @Tm_Version %>
           echo \"Blackbox version: ${TESSERA_VERSION}\";

           TESSERA_VERSION=\"${TESSERA_VERSION}-suffix\";

           TESSERA_CONFIG_TYPE=;

           if [ \"${TESSERA_VERSION}\" \\> \"0.8 \" ]; then TESSERA_CONFIG_TYPE=\"-enhanced\"; fi;
           if [[ \"${TESSERA_VERSION}\" \\> \"0.9 \" ]]; then TESSERA_CONFIG_TYPE=\"-9.0\"; fi;

           echo Config type ${TESSERA_CONFIG_TYPE};

           CONFIG_TMPL=$(cat ${DDIR}/tessera-config${TESSERA_CONFIG_TYPE}.json.tmpl);

           <%- @This_Host = ("#{@Node_UserIdent}".upcase + "_SERVICE_HOST").gsub("-", "_") -%>
           CONFIG_WITH_OTHER_HOSTS=$(echo $CONFIG_TMPL | <%= @Sed_Set_Node_Service_Host %>) ;
           CONFIG_WITH_ALL_HOSTS=$(echo $CONFIG_WITH_OTHER_HOSTS | sed \"s/%THIS_SERVICE_HOST%/$<%= @This_Host %>/g\");
           PRIV_KEY=$(cat $DDIR/tm.key)
           PUB_KEY=$(cat $DDIR/tm.pub)
           CONFIG_FINAL=$(echo $CONFIG_WITH_ALL_HOSTS | sed \"s-%THIS_PRIV_KEY%-${PRIV_KEY}-g\" |  sed \"s-%THIS_PUB_KEY%-${PUB_KEY}-g\");
           CONFIG_FINAL_9_0=$(echo $CONFIG_WITH_ALL_HOSTS | sed \"s-%THIS_PRIV_KEY%-${DDIR}/tm.key-g\" |  sed \"s-%THIS_PUB_KEY%-${DDIR}/tm.pub-g\");
           if [[ \"${TESSERA_VERSION}\" \\> \"0.9 \" ]]; then CONFIG_FINAL=${CONFIG_FINAL_9_0}; fi;
           echo $CONFIG_FINAL >  ${DDIR}/tessera-config-with-hosts.json;
           cat  ${DDIR}/tessera-config-with-hosts.json;
           /usr/local/bin/blackbox -configfile ${DDIR}/tessera-config-with-hosts.json;
        "
        ports:
          - containerPort: <%= @Tm_Port %>
        env:
          - name: QUORUM_HOME
            value: <%= @Node_DataDir %>
          - name: DDIR
            value: <%= @Node_DataDir %>/tm
        volumeMounts:
        - name: quorum-logs-persistent-storage
          mountPath: <%= @Node_DataDir %>/logs
        - name: tm-persistent-storage
          mountPath: <%= @Node_DataDir %>/tm
        - name: quorum-persistent-storage
          mountPath: <%= @Node_DataDir %>
        - name: keystore-tm
          mountPath: <%= @Node_DataDir %>/tm/tm.pub
          subPath: tm.pub
        - name: keystore-tm
          mountPath: <%= @Node_DataDir %>/tm/tm.key
          subPath: tm.key
        - name: tessera-config
          mountPath: <%= @Node_DataDir %>/tm/tessera-config.json.tmpl
          subPath: tessera-config.json.tmpl
      - name: quorum
        image: quay.io/smilo/go-smilo:<%= @Quorum_Version %>
        command: [ "sh" ]
        # TODO: have to generate sed files
        #       PERM_NODE_JSON=$(echo $PERM_NODE_TMPL | sed \"s/%QUORUM-NODE01_SERVICE_HOST%/$QUORUM_NODE01_SERVICE_HOST/g\" | sed \"s/%QUORUM-NODE02_SERVICE_HOST%/$QUORUM_NODE02_SERVICE_HOST/g\");
        # sleep to give constellation some time to start up and discover the other nodes.
        args:
        - "-cx"
        - "
         <% if @config["quorum"]["consensus"] == "istanbul" %>
           args=\" --smilobft.permissioned=true --smilobft.blockperiod 1 --smilobft.requesttimeout 10000 --syncmode full --mine --miner.gasprice 1 --miner.threads 1 --rpcapi admin,db,eth,debug,miner,net,shh,txpool,personal,web3,smilobft,sport  \";
         <% else %>
           args=\"--rpcapi admin,db,eth,debug,miner,net,shh,txpool,personal,web3,smilobft,sport \";
         <% end %>
           /usr/local/bin/geth \
           --datadir $QUORUM_DATA_DIR \
           $args \
           --nat=none \
           --verbosity <%= @Geth_Verbosity %> \
           --allow-insecure-unlock \
           --emitcheckpoints \
           --rpc \
           --rpcaddr 0.0.0.0 \
           --rpcport <%= @Node_WSPort %> \
           --port <%= @NodeP2P_ListenAddr %> \
           <%= @Geth_Startup_Params %> \
           --password $QUORUM_DATA_DIR/password.txt 2>&1 | tee -a <%= @Node_DataDir%>/logs/quorum.log;"
        ports:
          - containerPort: <%= @Node_WSPort %>
          - containerPort: <%= @NodeP2P_ListenAddr %>
        env:
        - name: PRIVATE_CONFIG
          value: <%= @Node_DataDir %>/tm/tm.ipc
        - name: QUORUM_DATA_DIR
          value: <%= @Node_DataDir %>/dd
        - name: QUORUM_HOME
          value: <%= @Node_DataDir %>
        - name: QHOME
          value: <%= @Node_DataDir %>
        - name: TM_HOME
          value: <%= @Node_DataDir %>/tm/
        volumeMounts:
        - name: genesis-config-persistent-storage
          mountPath: /etc/quorum/genesis/genesis-geth.json
          subPath: genesis-geth.json
        - name: quorum-persistent-storage
          mountPath: <%= @Node_DataDir%>
        - name: tm-persistent-storage
          mountPath: <%= @Node_DataDir%>/tm
        - name: quorum-key-config-persistent-storage
          mountPath: <%= @Node_DataDir%>/dd/keystore/key
          subPath: key
        - name: quorum-logs-persistent-storage
          mountPath: <%= @Node_DataDir %>/logs
        - name: quorum-nodekey
          mountPath: <%= @Node_DataDir%>/dd/geth/nodekey
          subPath: nodekey
        - name: quorum-permissioned-config
          mountPath: <%= @Node_DataDir%>/dd/permissioned-nodes.json.tmpl
          subPath: permissioned-nodes.json
        - name: quorum-permissioned-config
          mountPath: <%= @Node_DataDir%>/dd/static-nodes.json.tmpl
          subPath: permissioned-nodes.json
      volumes:
      - name: quorum-permissioned-config
        configMap:
          name: quorum-permissioned-config
          items:
          - key: permissioned-nodes.json
            path: permissioned-nodes.json
      - name: genesis-config-persistent-storage
        configMap:
          name: genesis-config
          items:
          - key: genesis-geth.json
            path: genesis-geth.json
      - name: tessera-config
        configMap:
          name: tessera-config
          items:
          - key: tessera-config.json.tmpl
            path: tessera-config.json.tmpl
      #     - key: tessera-config-enhanced.json.tmpl
      #       path: tessera-config-enhanced.json.tmpl
      #     - key: tessera-config-9.0.json.tmpl
      #       path: tessera-config-9.0.json.tmpl
      - name: contracts-config
        configMap:
          name: contracts-config
      - name: keystore-tm
        configMap:
          name: <%= @Node_UserIdent %>-tm-key-config
          items:
          - key: tm.pub
            path: tm.pub
          - key: tm.key
            path: tm.key
      - name: quorum-key-config-persistent-storage
        configMap:
          name: <%= @Node_UserIdent %>-account-key-config
          items:
          - key: key
            path: key
      - name: quorum-nodekey
        configMap:
          name: <%= @Node_UserIdent %>-nodekey-config
          items:
          - key: nodekey
            path: nodekey
      # PVC (configurable) https://kubernetes.io/docs/concepts/storage/persistent-volumes/#claims-as-volumes
     <% if @Storage_Type == "PVC" %>
      - name: quorum-persistent-storage
        persistentVolumeClaim:
          claimName: <%= @Node_UserIdent %>-quorum
      - name: tm-persistent-storage
        persistentVolumeClaim:
          claimName: <%= @Node_UserIdent %>-tm-pvc
      - name: quorum-logs-persistent-storage
        persistentVolumeClaim:
          claimName: <%= @Node_UserIdent %>-log-pvc
      # default is Host if not set.
      <% else %>
      - name: quorum-persistent-storage
        hostPath:
          path: <%= @DataDir%>/<%= @Node_UserIdent %>
      - name: tm-persistent-storage
        hostPath:
          path: <%= @DataDir%>/tm-<%= @Node_UserIdent %>
      - name: quorum-logs-persistent-storage
        hostPath:
          path: <%= @DataDir%>/<%= @Node_UserIdent %>-logs
      <% end %>
<% end -%>
